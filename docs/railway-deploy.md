# Деплой Interval Learn Bot на Railway

Эта инструкция описывает полный цикл развёртывания Telegram-бота на Railway с использованием подготовленного `Dockerfile`. Railway будет собирать контейнер через GitHub и автоматически перезапускать процесс при падении.

## 1. Подготовка репозитория
1. Убедитесь, что все изменения закоммичены и репозиторий доступен на GitHub.
2. В корне присутствуют файлы `Dockerfile`, `.dockerignore` и `railway.json` — Railway распознает, что проект нужно собирать как Docker-образ.
3. Удалите или дополните `.env` перед пушем (в репозитории должен быть только `.env.example`).

## 2. Создание проекта Railway
1. Залогиньтесь в [Railway](https://railway.app/) и нажмите **New Project → Deploy from GitHub repo**.
2. Дайте Railway доступ к репозиторию и выберите его в списке.
3. Railway увидит `Dockerfile` и запустит сборку (`npm ci`, `npm run build`, `npm start` внутри контейнера).
4. Дождитесь завершения первого билд-шага — он должен успешно выполнить `npm run build`. Миграции PostgreSQL применяются автоматически при старте приложения.

> **CLI-вариант:**  
> ```bash
> npm install -g @railway/cli
> railway login
> railway init --name interval-learn-bot
> railway link               # выберите созданный проект
> git push origin main       # Railway подтянет изменения и сделает деплой
> ```

## 3. Переменные окружения
В разделе **Variables** добавьте:

| Ключ | Обязательность | Описание |
| --- | --- | --- |
| `BOT_TOKEN` | да | Токен Telegram-бота |
| `CHAT_ID` | да | Канал, куда бот публикует напоминания (`-100...`) |
| `DASHBOARD_SECRET` | да | Пароль для входа в веб-панель |
| `DATABASE_URL` | да | Строка подключения к PostgreSQL (Railway Postgres заполняет автоматически) |
| `PORT` | нет | Порт HTTP-сервера (Railway выставит собственный порт, но можно оставить `3000`) |
| `INITIAL_REVIEW_MINUTES` | нет | Минуты до первого повторения (по умолчанию 10) |
| `REVIEW_SCAN_INTERVAL_MS` | нет | Интервал проверки очереди (по умолчанию 60000) |
| `REVIEW_BATCH_SIZE` | нет | Сколько карточек отправлять за один проход (по умолчанию 5) |

CLI-аналог:

```bash
railway variables set BOT_TOKEN=123456:token CHAT_ID=-10012345 DASHBOARD_SECRET=mysupersecret
# DATABASE_URL заполняется Railway автоматически при подключении встроенного Postgres
railway variables set INITIAL_REVIEW_MINUTES=20 REVIEW_SCAN_INTERVAL_MS=90000
```

> При добавлении Railway Postgres переменные `DATABASE_URL`, `DATABASE_PUBLIC_URL`, `PGHOST`, `PGPORT`, `PGUSER`, `PGPASSWORD` и др. будут заполнены автоматически. Боту достаточно `DATABASE_URL`.

## 4. Настройки деплоя
- В разделе **Deployments → Build** ничего менять не нужно: `railway.json` фиксирует использование Dockerfile.
- Start Command брать из образа не требуется, он уже задан через `CMD ["npm", "start"]` в Dockerfile.
- Отключите `Sleep Application`, чтобы бот не засыпал (значение уже установлено в `railway.json`).
- Для контроля доступности используется `GET /healthz`, указанный в `railway.json` как `healthcheckPath`.

## 5. Проверка и эксплуатация
1. После успешного деплоя откройте логи Railway и убедитесь, что бот запустился (`Бот запущен...`).
2. Проверьте, что `https://<service>.up.railway.app/healthz` возвращает `{"ok":true, ...}`.
3. Перейдите на `https://<service>.up.railway.app/` — появится форма входа, введите `DASHBOARD_SECRET` и убедитесь, что панель грузится.
4. Убедитесь, что в разделе Postgres → Query можно увидеть таблицу `cards`. Это подтвердит, что миграция прошла успешно.
5. Добавьте бота администратором в канал `CHAT_ID`.
6. Отправьте тестовое сообщение боту, нажмите «Добавить в обучение» — через заданный интервал он должен появиться в канале.

### Хранение данных
Все записи лежат в Railway Postgres. Бэкэнд сам применяет миграции при старте, поэтому бэквпы можно делать средствами Railway (Snapshots) или обычным `pg_dump`. Данные не зависят от контейнера, поэтому redeploy не обнуляет историю карточек.

### Перезапуск и обновления
- Любой `git push` в выбранную ветку триггерит новый деплой.
- Для ручного рестарта используйте кнопку **Redeploy** или команду `railway up`.
- Если нужно обновить переменные окружения, после изменения нажмите **Deploy** или выполните `railway redeploy`.

На этом интеграция готова: Railway автоматически собирает проект, запускает фонового бота, следит за healthcheck и хранит логи.
